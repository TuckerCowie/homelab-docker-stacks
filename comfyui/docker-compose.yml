version: "3.8"

networks:
  comfyui-network:
    driver: bridge
  tailscale-comfyui:
    driver: bridge

services:
  comfyui:
    image: ghcr.io/ai-dock/comfyui:latest
    container_name: comfyui
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
      # ComfyUI specific settings
      - WEB_ENABLE_AUTH=false
      - SERVERURL=auto
    volumes:
      # Persistent data - survives container restarts
      - ./data/models:/opt/ComfyUI/models
      - ./data/output:/opt/ComfyUI/output
      - ./data/input:/opt/ComfyUI/input
      - ./data/custom_nodes:/opt/ComfyUI/custom_nodes
      - ./data/user:/opt/ComfyUI/user
    networks:
      - comfyui-network
    # Uncomment if you have NVIDIA GPU
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    restart: unless-stopped

  # Internal nginx proxy - exposes app to Tailscale network
  comfyui-nginx:
    image: nginx:alpine
    container_name: comfyui-nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - comfyui-network
      - tailscale-comfyui
    depends_on:
      - comfyui
    restart: unless-stopped

  # Tailscale sidecar - provides secure network access
  comfyui-tailscale:
    image: tailscale/tailscale:latest
    container_name: comfyui-tailscale
    hostname: comfyui
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_EXTRA_ARGS=--accept-routes
    volumes:
      - ./data/tailscale:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    networks:
      - tailscale-comfyui
    restart: unless-stopped
