# =============================================================================
# Support Services - Media Enhancement & Management
# =============================================================================
# Services: Bazarr, Jellyseerr, Tdarr, Unpackerr, Notifiarr, FlareSolverr
#
# These services complement the Arr stack and Jellyfin.
# =============================================================================

services:
  # ===========================================================================
  # JELLYSEERR - Media Request Management
  # ===========================================================================
  # User-facing request portal for movies and TV shows
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    environment:
      - TZ=${TZ}
      - LOG_LEVEL=info
    volumes:
      - /mnt/docker-data/jellyseerr:/app/config
    ports:
      - "5055:5055"
    networks:
      - support-network
    restart: unless-stopped

  # ===========================================================================
  # BAZARR - Subtitle Management
  # ===========================================================================
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - /mnt/docker-data/bazarr:/config
      - /mnt/media/movies:/movies
      - /mnt/media/tv:/tv
    ports:
      - "6767:6767"
    networks:
      - support-network
    restart: unless-stopped

  # ===========================================================================
  # TDARR - Media Transcoding
  # ===========================================================================
  # Distributed transcoding to optimize media files
  tdarr:
    image: ghcr.io/haveagitgat/tdarr:latest
    container_name: tdarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - UMASK_SET=002
      - serverIP=0.0.0.0
      - serverPort=8266
      - webUIPort=8265
      - internalNode=true
      - inContainer=true
      - nodeName=BeeNode
    volumes:
      - /mnt/docker-data/tdarr/server:/app/server
      - /mnt/docker-data/tdarr/configs:/app/configs
      - /mnt/docker-data/tdarr/logs:/app/logs
      - /mnt/docker-data/tdarr-cache:/temp
      - /mnt/media:/media
    ports:
      - "8265:8265"   # WebUI
      - "8266:8266"   # Server
    networks:
      - support-network
    restart: unless-stopped

  # ===========================================================================
  # UNPACKERR - Archive Extraction
  # ===========================================================================
  # Automatically extracts downloaded archives for Sonarr/Radarr
  unpackerr:
    image: golift/unpackerr:latest
    container_name: unpackerr
    environment:
      - TZ=${TZ}
      # Sonarr configuration
      - UN_SONARR_0_URL=http://${DOCKER_LXC_IP:-localhost}:8989
      - UN_SONARR_0_API_KEY=${SONARR_API_KEY:-}
      - UN_SONARR_0_PATHS_0=/torrents
      # Radarr configuration
      - UN_RADARR_0_URL=http://${DOCKER_LXC_IP:-localhost}:7878
      - UN_RADARR_0_API_KEY=${RADARR_API_KEY:-}
      - UN_RADARR_0_PATHS_0=/torrents
    volumes:
      - /mnt/docker-data/unpackerr:/config
      - /mnt/torrents:/torrents
    networks:
      - support-network
    restart: unless-stopped

  # ===========================================================================
  # NOTIFIARR - Notification Client
  # ===========================================================================
  # Unified notifications for all *arr services
  notifiarr:
    image: golift/notifiarr:latest
    container_name: notifiarr
    hostname: notifiarr
    environment:
      - TZ=${TZ}
      - DN_API_KEY=${NOTIFIARR_API_KEY:-}
    volumes:
      - /mnt/docker-data/notifiarr:/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "5454:5454"
    networks:
      - support-network
    restart: unless-stopped

  # ===========================================================================
  # FLARESOLVERR - Cloudflare Bypass
  # ===========================================================================
  # Required by Prowlarr for some indexers with Cloudflare protection
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - TZ=${TZ}
      - LOG_LEVEL=info
      - CAPTCHA_SOLVER=none
    ports:
      - "8191:8191"
    networks:
      - support-network
    restart: unless-stopped

  # ===========================================================================
  # PROFILARR - Quality Profile Sync
  # ===========================================================================
  # Syncs quality profiles between Sonarr/Radarr instances
  profilarr:
    image: ghcr.io/recyclarr/profilarr:latest
    container_name: profilarr
    environment:
      - TZ=${TZ}
    volumes:
      - /mnt/docker-data/profilarr:/config
    networks:
      - support-network
    restart: unless-stopped

networks:
  support-network:
    name: support-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/24
          gateway: 172.26.0.1

  # Connect to arr-network for inter-stack communication
  arr-network:
    external: true
